<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AgendaFÃ¡cil â€” Carregando...</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0c10;
      --accent: #FF6B6B;
      --accent2: #FFA500;
      --text: #f0f2f5;
      --muted: #8892a4;
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'DM Sans', sans-serif;
      gap: 24px;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 60% at 20% 10%, rgba(255,107,107,0.12) 0%, transparent 60%),
        radial-gradient(ellipse 60% 80% at 80% 90%, rgba(255,165,0,0.08) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    .loader-wrap {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .brand-icon {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 8px 32px rgba(255,107,107,0.35);
      animation: pulse 1.8s ease-in-out infinite;
    }

    .brand-name {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #fff 30%, var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    /* Spinner */
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid rgba(255,107,107,0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .status-text {
      color: var(--muted);
      font-size: 0.85rem;
      letter-spacing: 0.3px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 8px 32px rgba(255,107,107,0.35); }
      50%       { transform: scale(1.06); box-shadow: 0 12px 40px rgba(255,107,107,0.5); }
    }
  </style>
</head>
<body>
  <div class="loader-wrap">
    <div class="brand-icon">ðŸ“…</div>
    <div class="brand-name">AgendaFÃ¡cil</div>
    <div class="spinner"></div>
    <span class="status-text" id="statusText">Verificando sessÃ£o...</span>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCuX3SRhDvZS_BiKIL1q_VFwacMBwZ5tbU",
      authDomain: "appagenda-f278b.firebaseapp.com",
      projectId: "appagenda-f278b",
      storageBucket: "appagenda-f278b.firebasestorage.app",
      messagingSenderId: "676987896115",
      appId: "1:676987896115:web:74ecdbedabca34f5923e46"
    };

    firebase.initializeApp(firebaseConfig);
    const auth  = firebase.auth();
    const db    = firebase.firestore();

    const statusText = document.getElementById('statusText');

    // â”€â”€ ROTEADOR PRINCIPAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    auth.onAuthStateChanged(async user => {
      if (!user) {
        // Sem sessÃ£o â†’ vai para login
        statusText.textContent = 'Redirecionando para o login...';
        window.location.replace('login.html');
        return;
      }

      try {
        statusText.textContent = 'Carregando perfil...';
        const docSnap = await db.collection('usuarios').doc(user.uid).get();

        if (!docSnap.exists) {
          // UsuÃ¡rio autenticado mas sem documento â†’ login para recriar
          statusText.textContent = 'Perfil nÃ£o encontrado. Redirecionando...';
          window.location.replace('login.html');
          return;
        }

        const data = docSnap.data();

        // Verifica assinatura
        const plano = await verificarAssinatura(user.uid, data);

        if (plano === 'bloqueado' || plano === 'vencido') {
          // Bloqueado â†’ login com aviso via query param
          statusText.textContent = 'Acesso bloqueado. Redirecionando...';
          window.location.replace('login.html?blocked=1');
          return;
        }

        // UsuÃ¡rio ativo â†’ painel
        statusText.textContent = 'Abrindo painel...';
        window.location.replace('painel.html');

      } catch (e) {
        console.error('[Router] Erro:', e);
        statusText.textContent = 'Erro ao verificar sessÃ£o. Redirecionando...';
        setTimeout(() => window.location.replace('login.html'), 2000);
      }
    });

    // â”€â”€ VERIFICAÃ‡ÃƒO DE ASSINATURA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function verificarAssinatura(uid, userData) {
      if (userData.plano === 'bloqueado') return 'bloqueado';

      const agora = new Date();
      const vencimento = userData.dataVencimento?.toDate
        ? userData.dataVencimento.toDate()
        : new Date(userData.dataVencimento);

      if (agora > vencimento) {
        await db.collection('usuarios').doc(uid).update({ plano: 'vencido' });
        return 'vencido';
      }

      return userData.plano || 'ativo';
    }

    // Timeout de seguranÃ§a: se demorar mais de 10s vai para login
    setTimeout(() => {
      statusText.textContent = 'Tempo esgotado. Redirecionando...';
      window.location.replace('login.html');
    }, 10000);
  </script>
</body>
</html>
